#!/bin/bash

#Prepends commit message with STRY, DEF, BAK tickets or MAINT

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
# echo "CURRENT_BRANCH = "${CURRENT_BRANCH}

separator=""
if [[ $CURRENT_BRANCH == *"_"* ]]
then
  #echo "branch name cotains underscore"
  separator="_"
elif [[ $CURRENT_BRANCH == *"-"* ]]
then
    #echo "branch name cotains hyphen"
    separator="-"
else
    separator=""
fi

arr=(${CURRENT_BRANCH//${separator}/ })
CURRENT_BRANCH=${arr[0]}

echo "CURRENT_BRANCH = "${CURRENT_BRANCH} #

# PREFIX_REGEX="((DEF|BAK|STRY|MAINT|def|bak|stry|maint|TNTC)[0-9]*)(_*).*"

PREFIX_REGEX="((DEF|BAK|STRY|MAINT|def|bak|stry|maint|TNTC)[0-9]*)"
COMMIT_MESSAGE=$(cat $COMMIT_MSG_FILE)
if [[ $CURRENT_BRANCH =~ $PREFIX_REGEX ]]
then
    TICKET="${BASH_REMATCH[0]}"
    # echo "TICKET IS = "${TICKET}
    
    if [[ $COMMIT_MESSAGE =~ $TICKET ]]
    then
        exit 0;
    fi

    echo "Ticket '${TICKET}', matched in current branch name, prepended to commit message."

    if [[ $COMMIT_MESSAGE == "TEST"* ]] || [[ $COMMIT_MESSAGE == "test"* ]] || [[ $COMMIT_MESSAGE == "MAINT"* ]] || [[ $COMMIT_MESSAGE == "maint"* ]]
    then
        echo ${COMMIT_MESSAGE}" - "${TICKET} > $COMMIT_MSG_FILE
    else
        echo "TEST: ${COMMIT_MESSAGE} - ${TICKET}" > $COMMIT_MSG_FILE
        echo "TEST: was pre-fixed to the commit message"
    fi

elif [[ $COMMIT_MESSAGE == "MAINT"* ]] || [[ $COMMIT_MESSAGE == "TEST"* ]] || [[ $COMMIT_MESSAGE == "test"* ]] || [[ $COMMIT_MESSAGE == "maint"* ]]
then
    exit 0;
else
    echo "TEST: "${COMMIT_MESSAGE} > $COMMIT_MSG_FILE
    echo "TEST: was pre-fixed to the commit message"
fi